#!/usr/bin/env bash
set -euo pipefail

vpsname=$1

bitwardenSignin() {
    ssh -t "$vpsname" "
# for darwin
export PATH=\$PATH:/opt/homebrew/bin/
. /etc/profile # adds nix to path
BW_CLIENTID=user.fc84d6d5-9ada-4210-a68f-a9f4003df894 BW_CLIENTSECRET=${BW_CLIENTSECRET:-$(secret-tool lookup password bitwarden-client-secret)} bw login jackmac92@protonmail.com --apikey
export BW_SESSION=\"\$(bw unlock --raw ${BW_PASSWORD:-$(secret-tool lookup password bitwarden-primary)})\"
touch /tmp/bw-temp-auth
echo
echo \"export BW_SESSION=\$BW_SESSION\" | tee /tmp/bw-temp-auth
source /tmp/bw-temp-auth
"
    ssh -t "$vpsname" '
      s util unlock-passwords
      . /tmp/bw-temp-auth
      echo -n "$BW_SESSION" | envchain --set main BW_SESSION
    '
}

chronic ssh "$vpsname" "rm -rf ~/.bw-auth ~/.config/Bitwarden\ CLI"
bitwardenSignin
