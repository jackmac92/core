#!/usr/bin/env bash
set -euo pipefail

jiraticket=$(s jira select-active-ticket-dwim "${1:-""}")

# ensure branchname has been setup
s cbi get-branchname-dwim "$jiraticket" >/dev/null

jiraLookupKnownReposFn() {
    sqlite3 "$JIRA_HELPER_DB" "SELECT repo FROM ticket_repos WHERE ticket=\"$jiraticket\""
}

export -f jiraLookupKnownReposFn

if [[ -z "$(jiraLookupKnownReposFn)" ]]; then
    s cbi ticket add-related-repos "$jiraticket"
fi

jiraLookupKnownReposFn | tee | xargs -n1 s cbi start-service
