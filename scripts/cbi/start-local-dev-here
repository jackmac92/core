#!/usr/bin/env bash
set -euo pipefail

# echo "BYPASSING RUN ON HOST TO RUN IN DOCKER"
# make
# exit 0

echo "auto gen envrc"
echo "
source_up
use cbirepovars
export GRPC_PORT=$(s util find-open-port)
" >.envrc
direnv allow

consul services register -http-addr=http://localhost:8500 -name $SVC_NAME -address $MY_LAN_IP -port $GRPC_PORT
trap "consul services deregister -id=$SVC_NAME" SIGINT

if [[ -f go.mod ]]; then
    echo "Starting go repo"
    fd -e go | entr -r go run main.go
fi

if [[ -f src/live_reload.py ]]; then
    echo "Starting python repo"

    echo "Installing deps"
    pip install grpcio==1.36.0 grpcio-tools==1.36.0 googleapis-common-protos==1.53.0
    pip install -r requirements.txt
    pip install --index-url https://__token__:$PYPI_TOKEN@gitlab.cbinsights.com/api/v4/projects/611/packages/pypi/simple -r internal_requirements.txt

    # s cbi python proto-compile
    python -c "from cbi.grpc import proto_find_and_compile; proto_find_and_compile('$PROTO_NAME');" && grep -rE "^[^#]*GRPC.get_service_client\(.+\n*\)" "$CBI_PY_SRC_ROOT" | grep -owE 'cbinsights\.[a-z0-9]+\.[a-z0-9]+' | while read -r line; do python -c "from cbi.grpc import proto_find_and_compile; proto_find_and_compile('$line');"; done

    cd src
    python live_reload.py
fi
