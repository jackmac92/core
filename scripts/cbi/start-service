#!/usr/bin/env bash
set -euo pipefail

target_service_name=${1:-$(s cbi svc select-dwim)}

if [ -z $target_service_name ]; then
  echo "Must provide a service name"
  exit 1
fi

if [ $target_service_name = engineering/legacy/cbi-site ]; then
  tmuxinator start cbi-site $target_service_name
  exit 0
fi

if [[ $# -gt 0 ]]; then shift; fi

if [ -d $HOME/cbinsights/gitlab.cbinsights.com/$target_service_name ]; then
  target_service=$HOME/cbinsights/gitlab.cbinsights.com/$target_service_name
fi

if [[ -z ${target_service:-""} ]]; then
  echo "Unknown service type or something: $target_service_name"
  exit 1
fi

target_service=$(realpath --relative-base $HOME/cbinsights "$target_service")

if [ -f ~/cbinsights/${target_service:-""}/go.mod ]; then
  tmuxinator start cbi-golang-service $target_service_name
  exit 0
fi

if [ -f ~/cbinsights/${target_service:-""}/src/setup.cfg ]; then
  tmuxinator start cbi-python-service $target_service_name
  exit 0
fi

echo "Unsupported service type?"
exit 1
