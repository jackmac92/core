#!/usr/bin/env zx

const argsAll = process.argv
const argsScriptIdx = argsAll.findIndex(s => s.endsWith(__filename))
const cmd = argsAll.slice(argsScriptIdx + 1)

const MAX_TRIES_N = 10000
const INTER_ATTEMPT_WAIT_MS = 1500

let final
let i = 0
while (true) {
  if (i >= MAX_TRIES_N) {
    throw Error("Too many attempts!")
  }
  i += 1
  try {
    let p = $`${cmd}`
    if (!process.env.UNTIL_CMD_VERBOSE) {
      p.quiet()
    }
    await p
    break
  } catch (e) {
    if (process.env.UNTIL_CMD_LOG_ERRORS) {
      console.log(`err[${i}]... retrying in ${INTER_ATTEMPT_WAIT_MS}ms`)
    }
    await sleep(INTER_ATTEMPT_WAIT_MS)
  }
}

try {
    for (const chunk of p.stdout) {
      echo(chunk)
    }
} catch (e2) {
    // echo`ignored error printing the final output`
}
