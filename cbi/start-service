#!/usr/bin/env bash
set -euo pipefail
target_service=${1:-$(s cbi svc-select-dwim)}
if [ -z $target_service ]; then
  echo "Must provide a service name"
  exit 1
fi
tmpfile="$(mktemp).yaml"
panes=$(
	python - <<___EOF
import copy
import json
start_after_lcl_svc = "s cbi maybe-checkout-branch-for-current-ticket; waitForIt 127.0.0.1:8500/v1/kv/Environment\?raw -- make local"
default = [{
  "shell_command": start_after_lcl_svc,
}, {
  "focus": "true"
}]
cbi_site_override = copy.deepcopy(default)
cbi_site_override.insert(1, {"shell_command": "waitForIt -t 60 127.0.0.1:3000 -- make logs"})
options = {
	"cbi-site": cbi_site_override
}
print(json.dumps(options.get("$target_service", default)))
___EOF
)
bat <<EOF >$tmpfile
session_name: $target_service
windows:
  - focus: "true"
    start_directory: ~/cbinsights/$target_service
    window_name: $target_service
    panes: $panes
    window_name: $target_service
EOF
tmuxp load -a $tmpfile
